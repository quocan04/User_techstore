<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n - Tech Store</title>

    <style>
        /* GI·ªÆ NGUY√äN GIAO DI·ªÜN C·ª¶A B·∫†N */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header { background-color: #f7f9fc; padding: 25px 40px; border-bottom: 1px solid #e6e9f0; }
        .header h1 { font-size: 24px; color: #333; font-weight: 600; }
        .checkout-content { display: flex; flex-wrap: wrap; }
        .form-section { flex: 60%; padding: 40px; border-right: 1px solid #e6e9f0; }
        .order-summary { flex: 40%; padding: 40px; background-color: #f7f9fc; }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #444;
            margin-bottom: 25px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            display: inline-block;
        }
        .form-row { display: flex; margin-bottom: 20px; gap: 20px; }
        .form-group { flex: 1; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .payment-methods { display: flex; flex-direction: column; gap: 15px; }
        .payment-option {
            display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px;
            cursor: pointer; transition: all 0.3s; background: #fff;
        }
        .payment-option.selected { border-color: #667eea; background: #f4f6ff; }
        .payment-option input[type="radio"] { margin-right: 15px; transform: scale(1.2); accent-color: #667eea; }
        .payment-logo { font-size: 30px; margin-right: 15px; }
        .payment-info .payment-name { font-weight: 600; color: #333; }
        .payment-info .payment-desc { font-size: 13px; color: #777; }
        .vnpay-note { margin-top: 15px; background: #e6f7ff; border: 1px solid #b3e0ff; color: #0056b3; padding: 12px; border-radius: 8px; font-size: 14px; display: none; }
        .vnpay-note.show { display: block; }
        .summary-items { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .summary-item { display: flex; align-items: center; margin-bottom: 20px; }
        .summary-item-img { width: 50px; height: 50px; border-radius: 8px; background: #e6e9f0; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; }
        .summary-item-info { flex-grow: 1; }
        .summary-item-name { font-weight: 500; color: #333; font-size: 15px; }
        .summary-item-qty { font-size: 13px; color: #777; }
        .summary-item-price { font-weight: 600; color: #444; font-size: 15px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; color: #555; }
        .summary-row.total { font-size: 18px; font-weight: 700; color: #333; padding-top: 15px; border-top: 1px solid #e0e0e0; margin-top: 15px; }
        .summary-row.total .price { color: #667eea; font-size: 20px; }
        .place-order-btn {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;
            margin-top: 20px; transition: all 0.3s;
        }
        .place-order-btn:hover { opacity: 0.9; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .place-order-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üí≥ Thanh To√°n ƒê∆°n H√†ng</h1>
    </div>

    <div class="checkout-content">
        <div class="form-section">
            <form id="checkoutForm">
                <div class="section-title">üì¶ Th√¥ng Tin Giao H√†ng</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>H·ªç v√† t√™n *</label>
                        <input type="text" name="fullName" placeholder="Nguy·ªÖn VƒÉn A" required>
                    </div>
                    <div class="form-group">
                        <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" name="phone" placeholder="0987654321" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>ƒê·ªãa ch·ªâ giao h√†ng *</label>
                    <textarea name="address" rows="3" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán" required></textarea>
                </div>
                <div class="form-group">
                    <label>Ghi ch√∫ (t√πy ch·ªçn)</label>
                    <textarea name="notes" rows="2" placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng..."></textarea>
                </div>

                <div class="section-title" style="margin-top: 30px;">üí∞ Ph∆∞∆°ng Th·ª©c Thanh To√°n</div>

                <div class="payment-methods">
                    <label class="payment-option selected" onclick="selectPayment('VNPAY')">
                        <input type="radio" name="paymentMethod" value="VNPAY" checked>
                        <div class="payment-logo">üè¶</div>
                        <div class="payment-info">
                            <div class="payment-name">Thanh to√°n VNPAY</div>
                            <div class="payment-desc">Thanh to√°n an to√†n qua c·ªïng VNPAY (ATM/QR Code)</div>
                        </div>
                    </label>
                    <label class="payment-option" onclick="selectPayment('COD')">
                        <input type="radio" name="paymentMethod" value="COD">
                        <div class="payment-logo">üíµ</div>
                        <div class="payment-info">
                            <div class="payment-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                            <div class="payment-desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                        </div>
                    </label>
                </div>

                <div class="vnpay-note show" id="vnpayNote">
                    ‚ö° <strong>L∆∞u √Ω:</strong> B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng sang c·ªïng VNPAY ƒë·ªÉ th·ª±c hi·ªán thanh to√°n.
                </div>
            </form>
        </div>

        <div class="order-summary">
            <div class="section-title">üìã ƒê∆°n H√†ng</div>
            <div class="summary-items" id="summary-items-list">
            </div>

            <div class="summary-row">
                <span>T·∫°m t√≠nh:</span>
                <span class="price" id="summary-subtotal">0 ‚Ç´</span>
            </div>
            <div class="summary-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span class="price">Mi·ªÖn ph√≠</span>
            </div>
            <div class="summary-row total">
                <span>T·ªïng c·ªông:</span>
                <span class="price" id="summary-total">0 ‚Ç´</span>
            </div>

            <button class="place-order-btn" onclick="placeOrder()">
                üöÄ ƒê·∫∑t H√†ng Ngay
            </button>
        </div>
    </div>
</div>

<script>
    let selectedPayment = 'VNPAY';
    let currentCart = null;

    // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn VNƒê
    function formatCurrency(number) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(number).replace('‚Ç´', '‚Ç´');
    }

    // Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        const selectedLabel = document.querySelector(`input[value="${method}"]`).closest('label');
        if (selectedLabel) selectedLabel.classList.add('selected');

        const vnpayNote = document.getElementById('vnpayNote');
        vnpayNote.classList.toggle('show', method === 'VNPAY');
    }

    // --- 1. T·∫¢I T√ìM T·∫ÆT GI·ªé H√ÄNG T·ª™ API ---
    async function loadCartSummary() {
        const itemsList = document.getElementById('summary-items-list');
        const totalEl = document.getElementById('summary-total');
        const subtotalEl = document.getElementById('summary-subtotal');

        itemsList.innerHTML = '<p>ƒêang t·∫£i ƒë∆°n h√†ng...</p>';

        try {
            // Quan tr·ªçng: credentials 'include' ƒë·ªÉ g·ª≠i Session Cookie ch·ª©a userId
            const response = await fetch('/api/user/cart', {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) throw new Error("L·ªói t·∫£i gi·ªè h√†ng");

            currentCart = await response.json();

            itemsList.innerHTML = '';
            if (!currentCart.items || currentCart.items.length === 0) {
                window.location.href = '/user/cart'; // V·ªÅ gi·ªè h√†ng n·∫øu tr·ªëng
                return;
            }

            currentCart.items.forEach(item => {
                itemsList.innerHTML += `
                    <div class="summary-item">
                        <div class="summary-item-img">üì±</div>
                        <div class="summary-item-info">
                            <div class="summary-item-name">${item.productName}</div>
                            <div class="summary-item-qty">S·ªë l∆∞·ª£ng: ${item.quantity}</div>
                        </div>
                        <div class="summary-item-price">${formatCurrency(item.subtotal)}</div>
                    </div>`;
            });

            subtotalEl.textContent = formatCurrency(currentCart.temporaryTotal);
            totalEl.textContent = formatCurrency(currentCart.grandTotal);

        } catch (error) {
            itemsList.innerHTML = '<p style="color:red">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            console.error(error);
        }
    }

    // --- 2. X·ª¨ L√ù ƒê·∫∂T H√ÄNG ---
    async function placeOrder() {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btn = document.querySelector('.place-order-btn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';

        const formData = new FormData(form);
        const requestData = {
            recipientName: formData.get('fullName'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            notes: formData.get('notes'),
            paymentMethod: selectedPayment
        };

        try {
            // G·ªçi ƒë·∫øn CheckoutController (/user/vnpay)
            const response = await fetch('/user/vnpay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (response.ok && result.paymentUrl) {
                // CHUY·ªÇN H∆Ø·ªöNG NG∆Ø·ªúI D√ôNG SANG C·ªîNG THANH TO√ÅN VNPAY
                window.location.href = result.paymentUrl;
            } else {
                alert("L·ªói ƒë·∫∑t h√†ng: " + (result.message || "Vui l√≤ng th·ª≠ l·∫°i"));
                btn.disabled = false;
                btn.innerHTML = 'üöÄ ƒê·∫∑t H√†ng Ngay';
            }
        } catch (error) {
            console.error("L·ªói:", error);
            alert("L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.");
            btn.disabled = false;
            btn.innerHTML = 'üöÄ ƒê·∫∑t H√†ng Ngay';
        }
    }

    // T·ª± ƒë·ªông load khi trang m·ªü
    document.addEventListener('DOMContentLoaded', loadCartSummary);



</script>

</body>
</html>